<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Time Tracker</title>
    <style>
        #timeTracker {
            text-align: center;
            margin-top: 20px;
        }

        #timerDisplay {
            font-size: 20px;
            margin-top: 10px;
        }

        #stopButton {
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .dropdown {
            position: relative;
            display: inline-block;
            cursor: pointer;
            border: 1px solid #ccc;
            width: 200px;
            padding: 5px;
        }

        .dropdown .dropdown-label {
            background-color: #f9f9f9;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown.open .dropdown-content {
            display: block;
            cursor: pointer;
        }

        /* Styling for selected options */
        .dropdown-content .option input[type="checkbox"]:checked + label {
            background-color: #e0e0e0;
        }

        .option:focus, .dropdown-label:focus {
            outline: 2px solid blue; /* Example focus style */
        }
    </style>
</head>
<body>
    <div id="timeTracker">
        <input type="text" id="taskInput" placeholder="Enter task description" />
        <select id="categorySelect">
            <option value="" selected>Select Category</option>
            <option value="Work">Work</option>
            <option value="Study">Study</option>
        </select>
        <select id="tagsSelect" multiple>
            <option value="Urgent">Urgent</option>
            <option value="Important">Important</option>
            <!-- Add more tags as needed -->
        </select>   
        <button id="startButton" onclick="startTimer()">Start</button>
        <button id="stopButton" onclick="stopTimer()">Stop</button>
        <div id="timerDisplay">00:00:00</div>
    </div>
    <div id="displayArea"></div>
    <script>
        let db;
        const timeRecordsDB = 'timeRecords'

        function openDatabase(callbacks) {
            const request = indexedDB.open("TimeTrackerDB", 1);

            request.onupgradeneeded = function(e) {
                db = e.target.result;
                db.createObjectStore(timeRecordsDB, { autoIncrement: true });
            };

            request.onsuccess = function(e) {
                db = e.target.result;
                for (let i = 0; i < callbacks.length; i += 1) {
                    callbacks[i]()
                }
            };

            request.onerror = function(e) {
                console.error("Error opening database: ", e);
            };
        }

        function formatTime(date) {
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            return hours.toString().padStart(2, '0') + ':' + minutes + ' ' + ampm;
        }

        function formatElapsedTime(elapsedTime) {
            const hours = Math.floor(elapsedTime / (1000 * 60 * 60));
            const minutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);

            return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function displayRecords() {
            const transaction = db.transaction(["timeRecords"], "readonly");
            const store = transaction.objectStore("timeRecords");
            const request = store.openCursor();

            const displayArea = document.getElementById('displayArea');
            displayArea.innerHTML = ''; // Clear previous entries

            // Create a table and header row
            const table = document.createElement('table');
            table.innerHTML = `
                <tr>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Tags</th>
                    <th>Time Range</th>
                    <th>Total Time</th>
                    <th>Actions</th>
                </tr>`;
            displayArea.appendChild(table);

            request.onsuccess = function(event) {
                const cursor = event.target.result;
                if (cursor) {
                    const record = cursor.value;
                    const row = table.insertRow();

                    const startTime = new Date(record.startTime);
                    const stopTime = new Date(record.stopTime);
                    const elapsedTime = new Date(stopTime - startTime);

                    const timeRange = `${formatTime(startTime)} - ${formatTime(stopTime)}`;
                    const totalElapsedTime = formatElapsedTime(elapsedTime);

                    createEditableCell(row, record.description, 'editable', cursor.key, record, 'description');
                    createEditableCell(row, record.category, 'editable', cursor.key, record, 'category');
                    createEditableCell(row, record.tags && record.tags.length > 0 ? record.tags.join(', ') : '', 'editable', cursor.key, record, 'tags');
                    createEditableCell(row, timeRange, 'editable');
                    createEditableCell(row, totalElapsedTime, 'editable');

                    // Cell for Edit and Delete buttons
                    const actionCell = row.insertCell();
                    actionCell.innerHTML = `<button onclick="deleteRecord(${cursor.key})">Delete</button>`;

                    cursor.continue();
                }
            };

            request.onerror = function(event) {
                console.error("Error in retrieving records: ", event);
            };
        }

        async function editRecordField(key, record, field, value) {
            const transaction = db.transaction([timeRecordsDB], "readwrite");
            const store = transaction.objectStore(timeRecordsDB);

            // TO BE UPDATED
            const updatedRecord = {...record}
            updatedRecord[field] = value

            const request = await store.put(updatedRecord, key);

            request.onsuccess = function(e) {
                const record = e.target.result;
                console.log("Record updated successfully", record);
                displayRecords(); // Refresh the displayed records
            };

            request.onerror = function(e) {
                console.error("Error updating record: ", e.target.error);
            };
        }

        function deleteRecord(key) {
            const transaction = db.transaction([timeRecordsDB], "readwrite");
            const store = transaction.objectStore(timeRecordsDB);
            store.delete(key);

            transaction.oncomplete = function() {
                console.log("Record deleted successfully");
                // Refresh the displayed records
                displayRecords();
            };

            transaction.onerror = function(e) {
                console.error("Error deleting record: ", e.target.error);
            };
        }

        openDatabase([displayRecords]);
    </script>
    <script>
        /* EDIT TABLE CELL FUNCTIONS */
        function createEditableCell(row, textContent, className, key, record, field) {
            let cell = row.insertCell();
            cell.className = className;
            cell.textContent = textContent;

            if (key) {
                cell.addEventListener('click', function() {
                    // Your logic to make the cell editable
                    makeCellEditable(this, key, record, field);
                });
            }
        }

        function makeCellEditable(td, key, record, field) {
            const originalText = td.textContent;
            td.innerHTML = `<input type="text" value="${originalText}" />`;
            const input = td.querySelector('input');
            input.focus();

            input.addEventListener('blur', function() {
                td.textContent = this.value; // Or handle updating the record in IndexedDB
                editRecordField(key, record, field, td.textContent)
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    this.blur(); // Triggers the blur event
                }
            });
        }

    </script>
    <script>
        /* TIMER FUNCTIONS */
        let currentStartTime, intervalId, currentTimeRecord;

        function getTimeRecord({
            startTime,
            stopTime
        }) {
            if (currentTimeRecord) {
                console.log('currenttimerecord', currentTimeRecord);
                if (stopTime) {
                    currentTimeRecord.stopTime = stopTime.toISOString()
                }
                return currentTimeRecord;
            } 

            let taskDescription = document.getElementById('taskInput').value;
            let category = document.getElementById('categorySelect').value;
            let tags = document.getElementById('tagsSelect').value;

            let record = {
                date: new Date(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate()).toISOString(),
                description: taskDescription || 'undefined',
                category: category,
                tags: tags,
                startTime: startTime ? startTime.toISOString() : undefined,
                stopTime: stopTime ? stopTime.toISOString() : undefined,
            };

            return record;
        }

        function resetCurrentTimeValues() {
            document.getElementById('taskInput').value = '';  // Reset the task description input
            document.getElementById('timerDisplay').textContent = '00:00:00';  // Reset the timer display
            currentStartTime = null;  // Reset any relevant variables
            intervalId = null;
            currentTimeRecord = null;
        }

        function startTimer() {
            if (!intervalId) {
                if (!currentStartTime) {
                    currentStartTime = new Date();
                }
                intervalId = setInterval(updateDisplay, 1000);
                document.getElementById('startButton').style.display = 'none';
                document.getElementById('stopButton').style.display = 'inline';

                let startTime = new Date();
                const record = getTimeRecord({ startTime })

                saveTimeRecord(record, { doReturnRecord: true, keyRecord: currentTimeRecord })
            }
        }

        function stopTimer() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;

                let stopTime = new Date();
                const record = getTimeRecord({ stopTime })

                saveTimeRecord(record);

                resetCurrentTimeValues()
                document.getElementById('startButton').style.display = 'inline';
                document.getElementById('stopButton').style.display = 'none';
                displayRecords()
            }
        }

        function updateDisplay() {
            const now = new Date();
            const elapsed = new Date(now - currentStartTime);
            const hours = elapsed.getUTCHours().toString().padStart(2, '0');
            const minutes = elapsed.getMinutes().toString().padStart(2, '0');
            const seconds = elapsed.getSeconds().toString().padStart(2, '0');
            document.getElementById('timerDisplay').textContent = `${hours}:${minutes}:${seconds}`;
        }

        async function saveTimeRecord({ key, ...record }, { doReturnRecord, keyRecord } = {}) {
            let request;
            const transaction = db.transaction([timeRecordsDB], "readwrite");
            const store = transaction.objectStore(timeRecordsDB);

            if (key) {
                request = await store.put(record, key);
            } else {
                request = await store.add(record);
            }

            request.onsuccess = function(e) {
                if (key) {
                    console.log("Time record updated:", e.target);
                } else {
                    console.log("Time record saved with key:", e.target.result);
                }
                if (doReturnRecord) {
                    record.key = e.target.result;
                    currentTimeRecord = record;
                } else {
                    currentTimeRecord = null;
                }
            };

            transaction.oncomplete = function() {
                if (key) {
                    console.log("Time record updated!");
                } else {
                    console.log("Time record saved!");
                }
            };

            transaction.onerror = function(e) {
                if (key) {
                    console.error("Error updating record: ", e);
                } else {
                    console.error("Error saving record: ", e);
                }
            };
        }
    </script>
</body>
</html>
